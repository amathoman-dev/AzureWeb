---
- name: Provision New Instances
  hosts: all
  gather_facts: false
  become: true

  vars:
    repo_path: "https://github.com/amathoman/OdeToFood"
    app_path: 'C:\Apps'
    app_name: "OdeToFood"

  tasks:
    - name: Install git
      win_chocolatey:
        name: git
        params: '/GitAndUnixToolsOnPath'
        state: present
      tags: pre_install

    - name: Install multiple packages sequentially
      win_chocolatey:
        name: '{{ item }}'
        state: present
      loop:
      - nodejs
      - dotnetcore-sdk
      tags: pre_install

    - name: Create directory structure
      win_file:
        path: "{{ app_path }}" 
        state: directory
      tags: pre_install

    - name: Delete Repo Directory
      win_file:
        path: '{{ app_path }}\{{ app_name }}'
        state: absent   
      tags: pre_install

    - name: clone repository
      win_shell: |
        cd "{{ app_path }}"
        git clone "{{ repo_path }}" 
      tags: pre_install
     
    - name: Run remote PowerShell Script
      win_command: powershell "C:\Apps\OdeToFood\install.ps1"
      tags: run ps_script